/** zs-permission.min.js - v0.0.21 - Tue, 11 Nov 2014 21:00:13 GMT */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),(t.ZSModule||(t.ZSModule={})).ZSPermission=e()}}(function(){return function e(t,r,n){function o(a,s){if(!r[a]){if(!t[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(i)return i(a,!0);var f=new Error("Cannot find module '"+a+"'");throw f.code="MODULE_NOT_FOUND",f}var p=r[a]={exports:{}};t[a][0].call(p.exports,function(e){var r=t[a][1][e];return o(r?r:e)},p,p.exports,e,t,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(e,t){function r(){function e(t,r){var n;if(t===!0)return!0;if(r===!0)return t=!0;if(i.isScalar(r))return t;if(i.isScalar(t))return t=i.deepCopy(r);if(Array.isArray(t)&&(t={_:t[0]||!1}),Array.isArray(r)&&(r={_:r[0]||!1}),t.grantNumber&&r.grantNumber)return t.min=Math.min(t.min,r.min),t.max=Math.max(t.max,r.max),t;if(t.grantNumber||r.grantNumber)return!1;if(void 0!==r._)for(n in t)"_"!==n&&void 0===r[n]&&(t[n]=e(t[n],r._));for(n in r)"_"!==n&&(t[n]=void 0!==t[n]?e(t[n],r[n]):void 0!==t._?e(i.deepCopy(r[n]),t._):i.deepCopy(r[n]));return void 0!==r._&&(t._=void 0!==t._?e(t._,r._):i.deepCopy(r._)),t||!1}for(var t=!1,r=0;r<arguments.length;r++)if(t=e(t,arguments[r]),t===!0)return!0;return t||!1}function n(e){if(e&&"object"==typeof e&&!e.grantNumber){var t={};return Object.keys(e).forEach(function(r){t[r]=n(e[r])}),t}return"number"==typeof e?{grantNumber:!0,min:e,max:e}:e}var o="undefined"!=typeof window?window.ZSModule.ZSError:"undefined"!=typeof global?global.ZSModule.ZSError:null,i="undefined"!=typeof window?window.ZSModule.objtools:"undefined"!=typeof global?global.ZSModule.objtools:null,a=function(e,t,r){this.grant=e,this._targetType=t,this._target=r};t.exports=a,a.prototype.getTargetType=function(){return this._targetType},a.prototype.getTarget=function(){return this._target},a.prototype.createSubgrantFromMask=function(e){return"string"==typeof e&&(e=this.getMask(e)),new a(e,this._targetType,this._target)},a.prototype.createSubgrantFromMasks=function(e){for(var t=[],n=0;n<e.length;n++)t.push("string"==typeof e[n]?this.getMask(e[n]):e[n]);var o=r(t);return new a(o,this._targetType,this._target)},a.prototype.asObject=function(){return this.grant},a.prototype.has=function(e,t){function r(e){return i.checkMaskPath(n.grant,e)}t||(t="");var n=this;if(this.grant===!0)return!0;if("object"!=typeof this.grant)return!1;if("string"==typeof e)return r(t+e);if(Array.isArray(e)){for(var o=0;o<e.length;o++)if(!r(t+e[o]))return!1;return!0}if("object"==typeof e&&e){for(var a in e)if(e[a]&&!r(t+e[a]))return!1;return!0}return!1},a.prototype.can=a.prototype.has,a.prototype.check=function(e,t){if(t||(t=""),"string"==typeof e){if(!this.has(e,t))return this._targetType?new o(o.ACCESS_DENIED,"Access denied trying to "+t+e+" a target of type "+this._targetType,{grantKey:t+e,targetType:this._targetType,target:this._target}):new o(o.ACCESS_DENIED,"Access denied trying to "+t+e)}else if(Array.isArray(e))for(var r=0;r<e.length;r++){var n=this.check(e[r],t);if(n)return n}else{if("object"!=typeof e||!e)return new o(o.INTERNAL_ERROR,"Supplied invalid key to permission checking function",{key:e});for(var i in e){var a=this.check(i,t);if(a)return a}}return null},a.prototype.checkMask=function(e,t){var r=null;if("string"==typeof e&&(r=e,e=this.getMask(r)),e===!0)return null;if(!e)return new o(o.ACCESS_DENIED,"Access denied in "+(r||"mask")+" for objects of type "+this._targetType,{grantKey:r,targetType:this._targetType,target:this._target});if(!t||"object"!=typeof t)return new o(o.INTERNAL_ERROR,"Tried to do permissions match against non-object");var n=i.getMaskedOutFields(t,e);return n.length?new o(o.ACCESS_DENIED,"Access denied in "+(r||"mask")+" for objects of type "+this._targetType+" to access field "+n[0],{grantKey:r,targetType:this._targetType,target:this._target}):null},a.prototype.get=function(e){function t(e,r){return r===!0?!0:e.length?"object"==typeof r&&r?t(e.slice(1),r[e[0]]):!1:r}return t(e.split("."),this.grant)},a.prototype.max=function(e){var t=this.get(e);return t===!0?1/0:t&&"object"==typeof t&&t.grantNumber&&"number"==typeof t.max?t.max:null},a.prototype.min=function(e){var t=this.get(e);return t===!0?-1/0:t&&"object"==typeof t&&t.grantNumber&&"number"==typeof t.min?t.min:null},a.prototype.getMask=function(e){var t=this.get(e);return t!==!0&&"object"!=typeof t?!1:t},a.prototype.combine=function(e){this.grant=r(this.grant,e.grant)},a.combineGrants=r,a.combineMasks=r,a.grantNumbersToObjects=n},{objtools:"objtools","zs-error":"zs-error"}],2:[function(e,t){function r(e,t,r){r||(this._array=e,this._vars=t,this._hashCache={},this.rebuild())}function n(e,t){function r(e){var o,i;for(o=0;o<e.perms.length;o++){var a=e.perms[o];(!a.target||s.queryMatches("Permission",a.target,t))&&n.push(e.perms[o].grant)}for(o=0;o<e.matches.length;o++){var f=e.matches[o],p=u.getPath(t,f.field);if(void 0!==p){var l;if(Array.isArray(p))for(i=0;i<p.length;i++)l=f.values[p[i]],l&&r(l);else l=f.values[p],l&&r(l)}}}var n=[];return r(e),n}function o(e,t,r){function n(e){var o,i,a;if(e.perms)for(o=0;o<e.perms.length;o++)if(e.perms[o].target)for(a=s.getQueriedFields(t||null,e.perms[o].target),i=0;i<a.length;i++)r[a[i]]=!0;if(e.matches)for(o=0;o<e.matches.length;o++){var u=e.matches[o];if(r[u.field]=!0,u.values)for(var f in u.values){var p=u.values[f];n(p)}}}n(e)}function i(e,t){function r(e){function r(e){var t,n,o;for(t=0;t<e.length;t++){if(n=e[t],n.target&&"object"==typeof n.target)for(o in n.target)"object"!=typeof n.target[o]&&"$"!=o[0]&&(u[o]=(u[o]||0)+1);Array.isArray(n.children)&&r(n.children)}}function n(e,t){var r,n,o,i,a={};for(o in e)a[o]=e[o];var s=l;for(r=0;r<p.length;r++)if(o=p[r],i=a[o],void 0!==i&&"object"!=typeof i){var u=null;for(n=0;n<s.matches.length;n++)s.matches[n].field==o&&(u=s.matches[n]);u||(u={field:o,values:{}},s.matches.push(u)),u.values[i]?s=u.values[i]:(s={perms:[],matches:[]},u.values[i]=s),delete a[o]}var c=Object.keys(a).length>0,y=!1;for(r=0;r<s.perms.length;r++)if(!s.perms[r].target&&!c||JSON.stringify(s.perms[r].target||null)==JSON.stringify(a)){s.perms[r].grant=f.combineGrants(s.perms[r].grant,t),y=!0;break}y||s.perms.push({target:c?a:void 0,grant:t})}function o(e,r){var i;for(i=0;i<e.length;i++){var u=e[i],p=u.target;if("string"==typeof p&&"{"==p[0])try{p=JSON.parse(p)}catch(l){}p&&"object"==typeof p&&s.substituteVars(p,t||{},!0);var c=f.grantNumbersToObjects(u.grant);r&&(p=a(p||{},r)),n(p,c),Array.isArray(u.children)&&o(u.children,p)}}var i,u={};r(e);var p=[];for(i in u)p.push(i);p.sort(function(e,t){return u[t]-u[e]});var l={perms:[],matches:[]};return o(e),l}var n,o,i,u={};for(n=0;n<e.length;n++)o=e[n],"target"!=o.type&&o.type||o.targetType&&(u[o.targetType]?u[o.targetType].push(o):u[o.targetType]=[o]);for(i in u)u[i]=r(u[i]);return u}function a(){if(!arguments.length)return!1;if(1==arguments.length)return arguments[0];for(var e,t={},r=[],n=0;n<arguments.length;n++){var o=arguments[n];o&&"object"==typeof o||(o={});for(e in o)if("$and"==e)Array.isArray(o.$and)&&Array.prototype.push.apply(r,o.$and);else if(void 0===t[e])t[e]=o[e];else{var i={},a={};i[e]=t[e],a[e]=o[e],r.push(i,a),delete t[e]}}return r.length&&(t.$and=r),t}var s="undefined"!=typeof window?window.ZSModule.commonQuery:"undefined"!=typeof global?global.ZSModule.commonQuery:null,u="undefined"!=typeof window?window.ZSModule.objtools:"undefined"!=typeof global?global.ZSModule.objtools:null,f=e("./grant"),p="undefined"!=typeof window?window.md5:"undefined"!=typeof global?global.md5:null,l="undefined"!=typeof window?window.ZSModule.ZSError:"undefined"!=typeof global?global.ZSModule.ZSError:null;t.exports=r,r.Grant=f,r.prototype.rebuild=function(){if(this._tree=i(this._array,this._vars),this._hashCache={},"undefined"!=typeof p)for(var e in this._tree)this.getHash(e)},r.prototype.getTargetGrant=function(e,t){var r=this._tree[e],o=this._tree["*"],i=[];return r&&Array.prototype.push.apply(i,n(r,t)),o&&Array.prototype.push.apply(i,n(o,t)),i.length?1==i.length?new f(i[0],e,t):new f(f.combineGrants.apply(null,i),e,t):new f(!1,e,t)},r.prototype.asArray=function(){return this._array},r.prototype.toJSON=function(){return this._array},r.prototype.getTargetQueryFields=function(e){var t=this._tree[e],r=this._tree["*"],n={};return t&&o(t,e,n),r&&o(r,e,n),Object.keys(n)},r.prototype.getHash=function(e){var t=e?e:"___";if(this._hashCache[t])return this._hashCache[t];var r=this.asArray();if(e&&(r=r.filter(function(t){return t.targetType===e}),!r.length))return"xxxxxxxx";var n=p(JSON.stringify(r));return this._hashCache[t]=n,n},r.prototype.createFilterByMask=function(e,t,r){var n=this;return function(o){var i=n.getTargetGrant(e,o||{});if(!i.has(t))return null;var a=i.getMask(r);return u.filterObj(o,a)}},r.prototype.checkExecuteQuery=function(e,t,r,n){var o,i=this.getTargetGrant(e,s.queryToObject(t));if(n){Array.isArray(n)||(n=[n]);for(var a=0;n>a;a++)(0===a||o)&&(o=i.check(n[a]))}else o=i.check("read")&&i.check("query");if(o)return o;if(o=i.check(s.getQueriedFields(e,t),"readMask."))return o;if(r&&r.fields){if(!Array.isArray(r.fields))return new l(l.BAD_REQUEST,"Permission-Set checkExecuteQuery got badly formatted fields option",{fields:r.fields});if(o=i.check(r.fields,"readMask."))return o}if(r&&r.sort){if(!Array.isArray(r.sort))return new l(l.BAD_REQUEST,"Permission-Set checkExecuteQuery got badly formatted sort option",{sort:r.sort});o=i.check(r.sort.map(function(e){return"string"!=typeof e?"":"-"==e[0]||"+"==e[0]?e.slice(1):e}),"readMask.")}if(o)return o;var u=i.max("maxQueryLimit");return null!==u&&void 0!==u&&1/0!==u&&r&&"number"==typeof r.limit&&r.limit>u?new l(l.ACCESS_DENIED,"The requested limit of "+r.limit+" is above your maximum allowed of "+u+" for type "+e):null},r.prototype.serialize=function(){return{_array:this._array,_vars:this._vars,_tree:this._tree,_hashCache:this._hashCache}},r.deserialize=function(e){var t=new r(null,null,!0);return t._array=e._array,t._vars=e._vars,t._tree=e._tree,t._hashCache=e._hashCache,t}},{"./grant":1,"blueimp-md5":"blueimp-md5","common-query":"common-query",objtools:"objtools","zs-error":"zs-error"}],"zs-permission":[function(e,t){t.exports=e("./permission-set")},{"./permission-set":2}]},{},[])("zs-permission")});